<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåü AI Academic Planner Ultra (Fixed)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* === VARIABLES & BASE STYLES === */
:root {
  --bg: #eef4ff; /* Light Blue/Gray */
  --card: #ffffff;
  --text: #2c3e50; /* Dark Navy */
  --primary: #4a69bd; /* Royal Blue */
  --accent: #3d55a8;
  --success: #2ecc71;
  --warning: #f1c40f;
  --danger: #e74c3c;
  --info: #3498db;
}
body.dark {
  --bg: #1f2937; /* Dark Gray */
  --card: #2c3e50;
  --text: #ecf0f1; /* Light Gray */
  --primary: #5d8aa8; /* Steel Blue */
  --accent: #4a6c88;
}
body {
  font-family: 'Inter', 'Segoe UI', sans-serif;
  margin: 0;
  background: var(--bg);
  color: var(--text);
  transition: 0.4s;
  line-height: 1.6;
}
header {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  text-align: center;
  padding: 1.8rem;
  position: relative;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
h1 { margin: 0.3rem 0; font-size: 2.2rem;}
h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.4rem; margin-bottom: 1rem; }
main { padding: 2rem; max-width: 1200px; margin: auto; display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
@media (max-width: 900px) {
  main { grid-template-columns: 1fr; padding: 1rem; }
}
section {
  background: var(--card);
  padding: 1.5rem;
  border-radius: 15px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  margin-bottom: 1.5rem;
  transition: 0.3s;
}
/* === FORMS & BUTTONS === */
input:not([type="checkbox"]), textarea, select, button {
  padding: 0.7rem;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 0.95rem;
  margin-bottom: 0.5rem;
  box-sizing: border-box; 
}
input:not([type="checkbox"]), textarea, select {
  width: 100%;
  background: var(--bg);
  color: var(--text);
}
button {
  background: var(--primary);
  color: white;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}
button:hover { background: var(--accent); transform: translateY(-1px); }
.btn-group button { width: auto; margin-right: 0.5rem; }
.toggle { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border:none; color:white; padding: 0.6rem 1rem; }

/* === SUBJECT TABS === */
.subject-tabs { display: flex; flex-wrap: wrap; gap: 0.7rem; margin-top: 1rem; border-bottom: 2px solid #ddd; padding-bottom: 0.5rem; }
.tab {
  background: #ecf0f1; color: var(--text);
  border-radius: 8px; padding: 0.6rem 1.2rem; cursor: pointer;
  transition: 0.2s; font-weight: 500;
}
.tab.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
body.dark .tab { background: #34495e; color: var(--text); }
body.dark .tab.active { background: var(--primary); color: white; }

/* === PROGRESS & TO-DO === */
.subject-details-content { display: flex; flex-direction: column; gap: 0.5rem;}
progress { width: 100%; height: 18px; border-radius: 9px; margin: 0.4rem 0; appearance: none; }
progress::-webkit-progress-bar { background-color: #eee; border-radius: 9px; }
progress::-webkit-progress-value { background-color: var(--success); border-radius: 9px; }
body.dark progress::-webkit-progress-bar { background-color: #34495e; }

.todo-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 0.6rem; border-bottom: 1px dashed #ddd;
  background: var(--card); border-radius: 4px; margin-top: 0.4rem;
}
.todo-item.done span { text-decoration: line-through; color: #7f8c8d; }
.todo-left { display: flex; align-items: center; gap: 0.8rem; }
.todo-priority { font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }
.priority-high { background-color: var(--danger); color: white; }
.priority-medium { background-color: var(--warning); color: var(--text); }
.priority-low { background-color: var(--success); color: white; }

/* === POMODORO & DASHBOARD === */
.pomodoro { text-align:center; padding: 2rem;}
.timer-display { font-size:4rem; margin:0.8rem 0; font-weight:bold; color: var(--accent); }
.pomodoro-controls button { width: 120px; margin: 0 5px; }
.stat-box { background: var(--bg); padding: 1rem; border-radius: 8px; margin-top: 1rem; }
.stat-box label { display: block; margin-bottom: 5px; font-weight: 600; }
.stat-box input { width: 100%; }

/* === EXAMS & QUIZ === */
.exam-item {
  background: var(--bg);
  padding: 0.8rem;
  border-radius: 8px;
  margin-top: 0.8rem;
  display: flex; justify-content: space-between; align-items: center;
}
.quiz-output .question { margin-bottom: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 8px; background: var(--bg); }
.quiz-output label { display: block; margin-left: 10px; }
</style>
</head>
<body>

<header>
  <h1>üåü AI Academic Planner Ultra (Fixed)</h1>
  <p id="current-week"></p>
  <button class="toggle" id="theme-toggle">üåô Dark Mode</button>
</header>

<main>
  <div class="left-column">
    <section>
      <h2><i class="fas fa-book"></i> Subject Manager</h2>
      <form id="subject-form" style="display: flex; gap: 0.5rem;">
        <input id="subject-name" placeholder="Subject Name (e.g., Quantum Physics)" required style="flex: 2;">
        <input id="subject-goal-progress" type="number" min="0" max="100" placeholder="Goal % (e.g., 90)" value="90" style="flex: 0.5;">
        <button type="submit" style="flex: 1;"><i class="fas fa-plus"></i> Add Subject</button>
      </form>
      <div class="subject-tabs" id="subject-tabs"></div>
      <div id="subject-details" style="margin-top:1.5rem;"></div>
    </section>

    <section>
      <h2><i class="fas fa-check-square"></i> To-Do Tasks for Current Subject</h2>
      <form id="todo-form" style="display: flex; gap: 0.5rem; align-items: center;">
        <input id="todo-input" placeholder="Add task details..." style="flex: 3;" required>
        <select id="todo-priority" style="flex: 1;">
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
        </select>
        <button type="submit" style="flex: 1;"><i class="fas fa-list-ul"></i> Add Task</button>
      </form>
      <div id="todo-list"></div>
    </section>

    <section>
      <h2><i class="fas fa-file-upload"></i> Upload Syllabus & Generate Quiz</h2>
      <input type="file" id="file-input" accept=".pdf,.txt">
      <pre id="file-content" style="max-height: 150px; overflow-y: auto; background: var(--bg); padding: 10px; border-radius: 6px;"></pre>
      <button id="generate-quiz"><i class="fas fa-robot"></i> Generate 3-Question MCQ Quiz (Mock)</button>
      <div id="quiz-output" style="margin-top:1rem;"></div>
    </section>
  </div>

  <div class="right-column">
    <section>
      <h2><i class="fas fa-chart-line"></i> Study Dashboard</h2>
      <canvas id="progressChart"></canvas>
      <div class="stat-box">
        <label for="daily-goal">Daily Study Goal (minutes):</label>
        <input type="number" id="daily-goal" value="90" min="1" onchange="saveDashboard()">
        <p>üïí Study time today: <span id="study-time">0 min</span> / <span id="goal-display">90 min</span></p>
        <progress id="goal-progress" value="0" max="90"></progress>
        <p style="font-size: 0.9em; color: var(--info); margin: 0; font-weight: 500;" id="ai-recommendation"></p>
      </div>
    </section>

    <section class="pomodoro">
      <h2><i class="fas fa-hourglass-half"></i> Pomodoro Timer</h2>
      <div class="timer-display" id="timer">25:00</div>
      <div class="pomodoro-controls">
        <button id="start-pause-timer"><i class="fas fa-play"></i> Start</button>
        <button id="reset-timer"><i class="fas fa-redo"></i> Reset</button>
      </div>
      <p id="pomodoro-status" style="font-weight: 500; font-size: 1.1rem; color: var(--accent);">Focus Time</p>
      <p>Completed Sessions: <span id="session-count">0</span></p>
    </section>

    <section>
      <h2><i class="fas fa-calendar-alt"></i> Exam Countdown</h2>
      <form id="exam-form">
        <input id="exam-name" placeholder="Exam name" required>
        <input id="exam-date" type="date" required>
        <button type="submit">Add Exam</button>
      </form>
      <div id="exam-list"></div>
    </section>
  </div>
</main>

<footer><p style="text-align: center; color: #7f8c8d; padding: 1rem;">¬© 2025 AI Academic Planner | Ultra Edition | Made with <i class="fas fa-heart" style="color: var(--danger);"></i></p></footer>

<script>
  // PDF.js worker setup
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

  // --- GLOBAL STATE & STORAGE HANDLERS ---
  let subjects = JSON.parse(localStorage.getItem("subjects")) || [];
  let exams = JSON.parse(localStorage.getItem("exams")) || [];
  let currentSubjectIndex = +(localStorage.getItem("currentSubjectIndex") || 0);
  let studySeconds = +(localStorage.getItem("studySeconds") || 0);
  let dailyGoal = +(localStorage.getItem("dailyGoal") || 90);

  function saveSubjects() { localStorage.setItem("subjects", JSON.stringify(subjects)); drawChart(); }
  function saveExams() { localStorage.setItem("exams", JSON.stringify(exams)); }
  function saveDashboard() {
    localStorage.setItem("studySeconds", studySeconds);
    dailyGoal = +(document.getElementById("daily-goal").value || 90);
    localStorage.setItem("dailyGoal", dailyGoal);
    updateDashboard();
  }
  function getCurrentSubject() { return subjects[currentSubjectIndex]; }

  // --- WEEK TRACKER ---
  const startDate = new Date("2025-07-01"); 
  document.getElementById("current-week").textContent =
    "üìÜ Week " + Math.ceil((new Date() - startDate) / (7 * 24 * 60 * 60 * 1000));

  // --- THEME TOGGLE ---
  const themeBtn = document.getElementById("theme-toggle");
  let darkMode = localStorage.getItem("darkMode") === "true";
  function setTheme() { document.body.classList.toggle("dark", darkMode); themeBtn.innerHTML = darkMode ? 'üí° Light Mode' : 'üåô Dark Mode'; }
  themeBtn.onclick = () => { darkMode = !darkMode; localStorage.setItem("darkMode", darkMode); setTheme(); };
  setTheme();

  // --- SUBJECT RENDERING & LOGIC ---
  const tabsContainer = document.getElementById("subject-tabs"), detailsEl = document.getElementById("subject-details");

  function calculateProgress(subject) {
    if (!subject.todos || subject.todos.length === 0) return 0;
    const completed = subject.todos.filter(x => x.done).length;
    return Math.round((completed / subject.todos.length) * 100);
  }

  function renderSubjects() {
    tabsContainer.innerHTML = "";
    subjects.forEach((s, i) => {
      const t = document.createElement("div");
      t.className = "tab" + (i === currentSubjectIndex ? " active" : "");
      t.textContent = s.name;
      t.onclick = () => { currentSubjectIndex = i; localStorage.setItem("currentSubjectIndex", i); renderSubjects(); };
      tabsContainer.appendChild(t);
    });

    if (subjects.length) {
      const s = getCurrentSubject();
      // ALWAYS recalculate before rendering details
      s.progress = calculateProgress(s); 
      detailsEl.innerHTML = `
        <h3>${s.name} ${s.progress >= s.goalProgress ? ' <i class="fas fa-check-circle" style="color:var(--success);"></i>' : ''}</h3>
        <div class="subject-details-content">
          <textarea id="subject-syllabus-edit" placeholder="Syllabus/Notes">${s.syllabus || ''}</textarea>
          <button onclick="saveSyllabus(${currentSubjectIndex})" class="btn-group"><i class="fas fa-save"></i> Save Notes</button>
          <label>Progress: <strong>${s.progress}%</strong> (Goal: ${s.goalProgress}%)</label>
          <progress value="${s.progress}" max="100"></progress>
          <div style="display:flex; gap: 10px;">
            <input type="number" id="progress-manual-edit" value="${s.progress}" min="0" max="100" style="width: 100px;">
            <input type="number" id="goal-manual-edit" value="${s.goalProgress}" min="0" max="100" style="width: 100px;">
            <button onclick="updateManualProgress(${currentSubjectIndex})" style="flex-grow: 1;"><i class="fas fa-sync"></i> Update Progress/Goal</button>
          </div>
          <button onclick="deleteSubject(${currentSubjectIndex})" style="background: var(--danger);"><i class="fas fa-trash"></i> Delete Subject</button>
        </div>`;
      renderTodos(); // Ensure todos for the active subject are rendered
    } else detailsEl.innerHTML = "<p>No subjects added yet. Start by adding one above!</p>";
    saveSubjects(); // Save state and draw chart
  }

  function saveSyllabus(i) {
    subjects[i].syllabus = document.getElementById("subject-syllabus-edit").value.trim();
    saveSubjects();
    renderSubjects(); // *FIX*: Rerender to show updated notes/UI
    alert("Syllabus/Notes saved!");
  }

  function updateManualProgress(i) {
    const progressVal = parseInt(document.getElementById("progress-manual-edit").value);
    const goalVal = parseInt(document.getElementById("goal-manual-edit").value);
    
    if (progressVal >= 0 && progressVal <= 100 && goalVal >= 0 && goalVal <= 100) {
      subjects[i].progress = progressVal;
      subjects[i].goalProgress = goalVal;
      saveSubjects();
      renderSubjects(); // *FIX*: Rerender to show updated progress/goal
    } else {
      alert("Progress and Goal must be between 0 and 100.");
    }
  }

  function deleteSubject(i) {
    if (!confirm(`Are you sure you want to delete ${subjects[i].name}? This cannot be undone.`)) return;
    subjects.splice(i, 1);
    if (currentSubjectIndex >= subjects.length) currentSubjectIndex = subjects.length > 0 ? 0 : -1;
    saveSubjects();
    renderSubjects(); // *FIX*: Rerender after deletion
  }

  document.getElementById("subject-form").onsubmit = e => {
    e.preventDefault();
    const name = document.getElementById("subject-name").value.trim(),
      goal = document.getElementById("subject-goal-progress").value.trim();
    if (!name) return;
    subjects.push({ name, syllabus: "", progress: 0, todos: [], goalProgress: +(goal || 90) });
    currentSubjectIndex = subjects.length - 1;
    saveSubjects();
    e.target.reset();
    renderSubjects(); // *FIX*: Rerender immediately after adding a subject
  };
  renderSubjects();

  // --- TODO RENDERING & LOGIC ---
  const todoForm = document.getElementById("todo-form"), todoList = document.getElementById("todo-list");

  function renderTodos() {
    todoList.innerHTML = "";
    if (!subjects.length || currentSubjectIndex < 0) return;
    
    getCurrentSubject().todos
      .sort((a, b) => { 
        const pOrder = { 'High': 3, 'Medium': 2, 'Low': 1, 'Unknown': 0 };
        if (a.done !== b.done) return a.done ? 1 : -1; 
        return pOrder[b.priority] - pOrder[a.priority];
      })
      .forEach((todo, i) => {
        const d = document.createElement("div");
        d.className = "todo-item" + (todo.done ? " done" : "");
        const priorityClass = `priority-${(todo.priority || 'Low').toLowerCase()}`;

        d.innerHTML = `
        <div class="todo-left">
          <input type='checkbox' ${todo.done ? 'checked' : ''} onchange="toggleTodo(${i})">
          <span class='todo-priority ${priorityClass}'>${todo.priority || 'Low'}</span>
          <span>${todo.text}</span>
        </div>
        <button onclick="deleteTodo(${i})" style="background: none; color: var(--danger); padding: 0.3rem; margin: 0;"><i class="fas fa-trash-alt"></i></button>`;
        todoList.appendChild(d);
      });
  }

  function toggleTodo(i) {
    const todos = getCurrentSubject().todos;
    // Find the original index of the item being toggled before sorting
    const itemToToggle = getCurrentSubject().todos
      .sort((a, b) => {
        const pOrder = { 'High': 3, 'Medium': 2, 'Low': 1, 'Unknown': 0 };
        if (a.done !== b.done) return a.done ? 1 : -1;
        return pOrder[b.priority] - pOrder[a.priority];
      })[i];
    
    const originalIndex = getCurrentSubject().todos.findIndex(item => item === itemToToggle);

    if (originalIndex !== -1) {
      todos[originalIndex].done = !todos[originalIndex].done;
      saveSubjects();
      renderSubjects(); // *FIX*: Rerender immediately to update list and progress bar
    }
  }

  function deleteTodo(i) {
    // Find original index to delete
    const itemToDelete = getCurrentSubject().todos
      .sort((a, b) => {
        const pOrder = { 'High': 3, 'Medium': 2, 'Low': 1, 'Unknown': 0 };
        if (a.done !== b.done) return a.done ? 1 : -1;
        return pOrder[b.priority] - pOrder[a.priority];
      })[i];
      
    const originalIndex = getCurrentSubject().todos.findIndex(item => item === itemToDelete);

    if (originalIndex !== -1) {
        getCurrentSubject().todos.splice(originalIndex, 1);
        saveSubjects();
        renderSubjects(); // *FIX*: Rerender immediately
    }
  }

  todoForm.onsubmit = e => {
    e.preventDefault();
    if (!subjects.length) return alert("Please add a subject first.");
    const text = document.getElementById("todo-input").value.trim();
    const priority = document.getElementById("todo-priority").value;
    if (!text) return;

    getCurrentSubject().todos.push({ text, done: false, priority });
    saveSubjects();
    renderSubjects(); // *FIX*: Rerender immediately after adding a task
    e.target.reset();
  };

  // --- STUDY DASHBOARD & TIMER ---
  function updateDashboard() {
    const mins = Math.floor(studySeconds / 60);
    const goalDisplayEl = document.getElementById("goal-display");
    const goalProgressEl = document.getElementById("goal-progress");
    const studyTimeEl = document.getElementById("study-time");
    const dailyGoalValue = +(document.getElementById("daily-goal").value || 90);

    studyTimeEl.textContent = `${mins} min`;
    goalDisplayEl.textContent = `${dailyGoalValue} min`;
    goalProgressEl.max = dailyGoalValue;
    goalProgressEl.value = Math.min(mins, dailyGoalValue);

    // AI Recommendation Mockup
    let rec = "You are on track to meet your study goal today. Keep the focus!";
    if (mins < dailyGoalValue / 4) rec = "It's a low effort day. Time to schedule a focused Pomodoro session!";
    else if (mins < dailyGoalValue / 2) rec = "Good start! Halfway to your daily goal. Tackle a high-priority task next.";
    else if (mins >= dailyGoalValue) rec = "Goal achieved! Consider a deep review of current subject notes or a relaxing long break.";
    
    document.getElementById("ai-recommendation").textContent = `‚ú® AI Suggests: ${rec}`;
  }

  // Timer: Increments every minute, updates dashboard
  setInterval(() => {
    studySeconds++;
    saveDashboard();
  }, 60000);
  updateDashboard(); 

  // --- CHART ---
  const ctx = document.getElementById("progressChart");
  const chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Subject Progress %",
        data: [],
        backgroundColor: [], 
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Progress %' } },
        x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
      },
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Subject Progress vs. Goal' }
      }
    }
  });

  function drawChart() {
    chart.data.labels = subjects.map(s => s.name);
    chart.data.datasets[0].data = subjects.map(s => s.progress);
    chart.data.datasets[0].backgroundColor = subjects.map(s => s.progress >= s.goalProgress ? 'var(--success)' : 'var(--primary)');
    chart.update();
  }

  // --- FILE + QUIZ (MOCK API) ---
  let syllabusText = "";
  const fileInput = document.getElementById("file-input"), fileContent = document.getElementById("file-content");

  fileInput.onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    fileContent.textContent = "Processing file...";
    try {
      if (f.type === "text/plain") { syllabusText = await f.text(); }
      else if (f.type === "application/pdf") {
        const pdf = await pdfjsLib.getDocument(URL.createObjectURL(f)).promise;
        let t = "";
        for (let i = 1; i <= Math.min(3, pdf.numPages); i++) { 
          const p = await pdf.getPage(i);
          const c = await p.getTextContent();
          t += c.items.map(it => it.str).join(" ") + " ";
        }
        syllabusText = t;
      }
      fileContent.textContent = syllabusText.slice(0, 800) + (syllabusText.length > 800 ? "\n... (Content truncated for display)" : "");
      if (subjects.length && confirm("Do you want to save this text as the syllabus for the current subject?")) {
        getCurrentSubject().syllabus = syllabusText;
        saveSubjects();
        renderSubjects(); // *FIX*: Rerender after updating syllabus
      }
    } catch (error) {
      fileContent.textContent = "Error processing file: " + error.message;
    }
  };

  async function generateMCQs(text) {
    // *** MOCK FUNCTION: Simulates AI Quiz Generation ***
    await new Promise(r => setTimeout(r, 1500)); 
    return {
      questions: [
        { question: "What is the capital of France?", options: ["Berlin", "Paris", "Madrid"], answer: "Paris" },
        { question: "What is 2 + 2?", options: ["3", "4", "5"], answer: "4" },
        { question: "What year is this planner set in?", options: ["2024", "2025", "2026"], answer: "2025" }
      ]
    };
  }

  document.getElementById("generate-quiz").onclick = async () => {
    const out = document.getElementById("quiz-output");
    let sourceText = syllabusText.trim() || (subjects.length && getCurrentSubject().syllabus.trim());
    
    if (!sourceText) { out.innerHTML = "<p style='color:var(--danger);'>Upload syllabus first or save notes to current subject.</p>"; return; }
    out.innerHTML = "<p><i class='fas fa-spinner fa-spin'></i> AI Generating MCQs...</p>";
    try {
      const q = await generateMCQs(sourceText);
      if (!q.questions || q.questions.length === 0) return out.innerHTML = "‚ö†Ô∏è No questions generated. Try a longer text.";

      let html = "<h3>Generated Quiz</h3><form id='generated-quiz-form'>";
      q.questions.forEach((qu, i) => {
        html += `<div class='question'><strong>${i + 1}. ${qu.question}</strong><br>`;
        qu.options.forEach(opt => html += `<label><input type='radio' name='q${i}' value='${opt}'> ${opt}</label><br>`);
        html += "</div>";
      });
      html += "</form><button id='submit-quiz' style='margin-top: 10px;'><i class='fas fa-paper-plane'></i> Submit Quiz</button>";
      out.innerHTML = html;

      document.getElementById("submit-quiz").onclick = () => {
        let correct = 0;
        q.questions.forEach((qu, i) => {
          const sel = document.querySelector(`input[name='q${i}']:checked`);
          if (sel && sel.value === qu.answer) correct++;
        });

        const score = Math.round((correct / q.questions.length) * 100);
        
        if (subjects.length) {
          const currentProgress = getCurrentSubject().progress;
          getCurrentSubject().progress = Math.round(currentProgress * 0.7 + score * 0.3);
          saveSubjects();
          renderSubjects(); // *FIX*: Rerender after quiz score updates progress
        }

        out.innerHTML = `<p>‚úÖ Quiz Complete! You scored <strong>${score}%</strong> (${correct}/${q.questions.length}). Subject progress slightly updated!</p>`;
      };

    } catch (e) { out.innerHTML = "<p style='color:var(--danger);'>Error generating quiz.</p>"; console.error(e); }
  };

  // --- POMODORO LOGIC ---
  let pomodoro = {
    timer: 25 * 60, isRunning: false, isBreak: false, interval: null,
    focusTime: 25 * 60, shortBreak: 5 * 60, longBreak: 15 * 60,
    sessionCount: +(localStorage.getItem("pomodoroSessions") || 0)
  };

  const timerDisplay = document.getElementById("timer"), statusEl = document.getElementById("pomodoro-status"), sessionCountEl = document.getElementById("session-count");
  sessionCountEl.textContent = pomodoro.sessionCount;

  function updateTimerDisplay() {
    let m = Math.floor(pomodoro.timer / 60), s = pomodoro.timer % 60;
    timerDisplay.textContent = `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
  }

  function startPausePomodoro() {
    if (pomodoro.isRunning) {
      clearInterval(pomodoro.interval);
      pomodoro.isRunning = false;
      document.getElementById("start-pause-timer").innerHTML = '<i class="fas fa-play"></i> Resume';
    } else {
      Notification.requestPermission().then(() => {
        pomodoro.isRunning = true;
        document.getElementById("start-pause-timer").innerHTML = '<i class="fas fa-pause"></i> Pause';
        pomodoro.interval = setInterval(() => {
          pomodoro.timer--;
          if (pomodoro.timer <= 0) {
            clearInterval(pomodoro.interval);
            pomodoro.isRunning = false;
            
            if (!pomodoro.isBreak) { // Finished Focus
              pomodoro.sessionCount++;
              localStorage.setItem("pomodoroSessions", pomodoro.sessionCount);
              sessionCountEl.textContent = pomodoro.sessionCount;
              
              if (pomodoro.sessionCount % 4 === 0) {
                pomodoro.timer = pomodoro.longBreak;
                pomodoro.isBreak = true;
                statusEl.textContent = "üöÄ Long Break (15 min)";
                statusEl.style.color = 'var(--success)';
              } else {
                pomodoro.timer = pomodoro.shortBreak;
                pomodoro.isBreak = true;
                statusEl.textContent = "‚òï Short Break (5 min)";
                statusEl.style.color = 'var(--warning)';
              }
            } else { // Finished Break
              pomodoro.timer = pomodoro.focusTime;
              pomodoro.isBreak = false;
              statusEl.textContent = "üéØ Focus Time (25 min)";
              statusEl.style.color = 'var(--accent)';
            }

            new Notification("Pomodoro", { body: statusEl.textContent, icon: "https://via.placeholder.com/128/4a69bd/ffffff?text=AI" });
            startPausePomodoro(); // Auto-start next session
          }
          updateTimerDisplay();
        }, 1000);
      });
    }
  }

  document.getElementById("start-pause-timer").onclick = startPausePomodoro;

  document.getElementById("reset-timer").onclick = () => {
    clearInterval(pomodoro.interval);
    pomodoro.isRunning = false;
    pomodoro.isBreak = false;
    pomodoro.timer = pomodoro.focusTime;
    statusEl.textContent = "üéØ Focus Time (25 min)";
    statusEl.style.color = 'var(--accent)';
    document.getElementById("start-pause-timer").innerHTML = '<i class="fas fa-play"></i> Start';
    updateTimerDisplay();
  };
  updateTimerDisplay();


  // --- EXAMS RENDERING & LOGIC ---
  const examList = document.getElementById("exam-list");

  function renderExams() {
    examList.innerHTML = "";
    exams.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach((ex, i) => {
      const d = document.createElement("div"); d.className = "exam-item";
      const diffTime = new Date(ex.date) - new Date();
      const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      let statusText, statusColor;
      if (days > 30) { statusText = `${days} days left`; statusColor = 'var(--success)'; }
      else if (days > 7) { statusText = `${days} days left`; statusColor = 'var(--info)'; }
      else if (days > 0) { statusText = `üö® ${days} days left!`; statusColor = 'var(--danger)'; }
      else if (days === 0) { statusText = 'üî• TODAY!'; statusColor = 'var(--danger)'; }
      else { statusText = '‚úÖ Completed'; statusColor = '#7f8c8d'; }

      d.innerHTML = `
        <div>
          <strong>${ex.name}</strong> (${ex.date})
          <p style="color: ${statusColor}; font-weight: bold; margin: 0; font-size: 0.9em;">${statusText}</p>
        </div>
        <button onclick="deleteExam(${i})" style="background: none; color: var(--danger); padding: 0.3rem; margin: 0;"><i class="fas fa-trash-alt"></i></button>`;
      examList.appendChild(d);
    });
  }

  function deleteExam(i) {
    if (!confirm("Remove this exam?")) return;
    exams.splice(i, 1); saveExams(); renderExams();
  }

  document.getElementById("exam-form").onsubmit = e => {
    e.preventDefault();
    const name = document.getElementById("exam-name").value.trim(),
      date = document.getElementById("exam-date").value;
    if (!name || !date) return;
    exams.push({ name, date }); saveExams(); e.target.reset(); renderExams(); // *FIX*: Rerender immediately after adding an exam
  };
  renderExams();

  // --- AUTO REFRESH LOOP ---
  // This is still useful for updating exam countdowns and study time every 30 seconds.
  setInterval(() => {
    renderSubjects(); 
    renderExams();
    updateDashboard();
  }, 30000); 

  // --- INSTANT UPDATE ON STORAGE CHANGE ---
  window.addEventListener("storage", () => {
    subjects = JSON.parse(localStorage.getItem("subjects")) || [];
    exams = JSON.parse(localStorage.getItem("exams")) || [];
    studySeconds = +(localStorage.getItem("studySeconds") || 0);
    pomodoro.sessionCount = +(localStorage.getItem("pomodoroSessions") || 0);
    
    renderSubjects();
    renderExams();
    updateDashboard();
  });
</script>
</body>
</html>